# Task 005 - [MOYENNE] : Service SAF-T Export

## Fichier(s) a modifier
- `src/services/exportSAFT.js` (nouveau fichier)

## Probleme
CashPilot ne supporte pas l'export au format SAF-T (Standard Audit File for Tax), norme OCDE utilisee dans de nombreux pays europeens (Portugal, Norvege, Pologne, Luxembourg, etc.).

## Solution
Creer un service d'export SAF-T generant un fichier XML conforme au schema OCDE.

## Code attendu
```javascript
/**
 * Export SAF-T (Standard Audit File for Tax)
 * Format XML standard OCDE pour l'echange de donnees fiscales
 * Schema: urn:OECD:StandardAuditFile-Tax
 */

/**
 * Echappe les caracteres speciaux XML
 */
const escapeXml = (str) => {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
};

/**
 * Format une date au format ISO (YYYY-MM-DD)
 */
const formatDate = (date) => {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '';
  return d.toISOString().split('T')[0];
};

/**
 * Format une date-heure au format ISO
 */
const formatDateTime = (date) => {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '';
  return d.toISOString();
};

/**
 * Format un montant (2 decimales)
 */
const formatAmount = (amount) => {
  if (amount === null || amount === undefined) return '0.00';
  return Number(amount).toFixed(2);
};

/**
 * Genere la section Header du SAF-T
 */
const generateHeader = (companyInfo, period, auditFileId) => {
  return `
  <Header>
    <AuditFileVersion>2.00</AuditFileVersion>
    <AuditFileCountry>${escapeXml(companyInfo.country || 'FR')}</AuditFileCountry>
    <AuditFileDateCreated>${formatDate(new Date())}</AuditFileDateCreated>
    <SoftwareCompanyName>CashPilot</SoftwareCompanyName>
    <SoftwareID>CashPilot</SoftwareID>
    <SoftwareVersion>1.0.0</SoftwareVersion>
    <Company>
      <RegistrationNumber>${escapeXml(companyInfo.siren || companyInfo.tax_id || '')}</RegistrationNumber>
      <Name>${escapeXml(companyInfo.company_name || '')}</Name>
      <Address>
        <StreetName>${escapeXml(companyInfo.address || '')}</StreetName>
        <City>${escapeXml(companyInfo.city || '')}</City>
        <PostalCode>${escapeXml(companyInfo.postal_code || '')}</PostalCode>
        <Country>${escapeXml(companyInfo.country || 'FR')}</Country>
      </Address>
      <Contact>
        <ContactPerson>
          <FirstName>${escapeXml(companyInfo.contact_first_name || '')}</FirstName>
          <LastName>${escapeXml(companyInfo.contact_last_name || '')}</LastName>
        </ContactPerson>
        <Email>${escapeXml(companyInfo.email || '')}</Email>
      </Contact>
      <TaxRegistration>
        <TaxRegistrationNumber>${escapeXml(companyInfo.vat_number || '')}</TaxRegistrationNumber>
        <TaxType>TVA</TaxType>
      </TaxRegistration>
    </Company>
    <DefaultCurrencyCode>${companyInfo.currency || 'EUR'}</DefaultCurrencyCode>
    <SelectionCriteria>
      <SelectionStartDate>${formatDate(period.start)}</SelectionStartDate>
      <SelectionEndDate>${formatDate(period.end)}</SelectionEndDate>
    </SelectionCriteria>
    <TaxAccountingBasis>Invoice</TaxAccountingBasis>
  </Header>`;
};

/**
 * Genere la section MasterFiles - GeneralLedgerAccounts
 */
const generateAccounts = (accounts) => {
  if (!accounts || accounts.length === 0) return '';

  const accountsXml = accounts.map(account => `
      <Account>
        <AccountID>${escapeXml(account.account_code)}</AccountID>
        <AccountDescription>${escapeXml(account.account_name)}</AccountDescription>
        <StandardAccountID>${escapeXml(account.standard_code || account.account_code)}</StandardAccountID>
        <AccountType>${escapeXml(account.account_type || 'GL')}</AccountType>
        <OpeningDebitBalance>${formatAmount(account.opening_debit || 0)}</OpeningDebitBalance>
        <OpeningCreditBalance>${formatAmount(account.opening_credit || 0)}</OpeningCreditBalance>
        <ClosingDebitBalance>${formatAmount(account.closing_debit || 0)}</ClosingDebitBalance>
        <ClosingCreditBalance>${formatAmount(account.closing_credit || 0)}</ClosingCreditBalance>
      </Account>`).join('');

  return `
    <GeneralLedgerAccounts>
      ${accountsXml}
    </GeneralLedgerAccounts>`;
};

/**
 * Genere la section MasterFiles - Customers
 */
const generateCustomers = (customers) => {
  if (!customers || customers.length === 0) return '';

  const customersXml = customers.map(customer => `
      <Customer>
        <CustomerID>${escapeXml(customer.id)}</CustomerID>
        <Name>${escapeXml(customer.name)}</Name>
        <Address>
          <StreetName>${escapeXml(customer.address || '')}</StreetName>
          <City>${escapeXml(customer.city || '')}</City>
          <PostalCode>${escapeXml(customer.postal_code || '')}</PostalCode>
          <Country>${escapeXml(customer.country || 'FR')}</Country>
        </Address>
        ${customer.vat_number ? `<TaxRegistration>
          <TaxRegistrationNumber>${escapeXml(customer.vat_number)}</TaxRegistrationNumber>
          <TaxType>TVA</TaxType>
        </TaxRegistration>` : ''}
        <Contact>
          <Email>${escapeXml(customer.email || '')}</Email>
          <Telephone>${escapeXml(customer.phone || '')}</Telephone>
        </Contact>
      </Customer>`).join('');

  return `
    <Customers>
      ${customersXml}
    </Customers>`;
};

/**
 * Genere la section MasterFiles - Suppliers
 */
const generateSuppliers = (suppliers) => {
  if (!suppliers || suppliers.length === 0) return '';

  const suppliersXml = suppliers.map(supplier => `
      <Supplier>
        <SupplierID>${escapeXml(supplier.id)}</SupplierID>
        <Name>${escapeXml(supplier.name)}</Name>
        <Address>
          <StreetName>${escapeXml(supplier.address || '')}</StreetName>
          <City>${escapeXml(supplier.city || '')}</City>
          <PostalCode>${escapeXml(supplier.postal_code || '')}</PostalCode>
          <Country>${escapeXml(supplier.country || 'FR')}</Country>
        </Address>
        ${supplier.vat_number ? `<TaxRegistration>
          <TaxRegistrationNumber>${escapeXml(supplier.vat_number)}</TaxRegistrationNumber>
          <TaxType>TVA</TaxType>
        </TaxRegistration>` : ''}
        <Contact>
          <Email>${escapeXml(supplier.email || '')}</Email>
          <Telephone>${escapeXml(supplier.phone || '')}</Telephone>
        </Contact>
      </Supplier>`).join('');

  return `
    <Suppliers>
      ${suppliersXml}
    </Suppliers>`;
};

/**
 * Genere la section GeneralLedgerEntries
 */
const generateEntries = (entries) => {
  if (!entries || entries.length === 0) return '';

  // Grouper par journal
  const journalGroups = entries.reduce((acc, entry) => {
    const journalId = entry.journal_code || 'OD';
    if (!acc[journalId]) {
      acc[journalId] = [];
    }
    acc[journalId].push(entry);
    return acc;
  }, {});

  let totalDebit = 0;
  let totalCredit = 0;
  let numberOfEntries = 0;

  const journalsXml = Object.entries(journalGroups).map(([journalId, journalEntries]) => {
    const transactionsXml = journalEntries.map((entry, index) => {
      const debitAmount = entry.debit || 0;
      const creditAmount = entry.credit || 0;
      totalDebit += debitAmount;
      totalCredit += creditAmount;
      numberOfEntries++;

      return `
        <Transaction>
          <TransactionID>${escapeXml(entry.entry_number || `${journalId}-${index + 1}`)}</TransactionID>
          <Period>${new Date(entry.transaction_date).getMonth() + 1}</Period>
          <PeriodYear>${new Date(entry.transaction_date).getFullYear()}</PeriodYear>
          <TransactionDate>${formatDate(entry.transaction_date)}</TransactionDate>
          <SourceID>${escapeXml(entry.created_by || 'SYSTEM')}</SourceID>
          <Description>${escapeXml(entry.description || '')}</Description>
          <SystemEntryDate>${formatDateTime(entry.created_at || entry.transaction_date)}</SystemEntryDate>
          <GLPostingDate>${formatDate(entry.validated_at || entry.transaction_date)}</GLPostingDate>
          <Line>
            <RecordID>${escapeXml(entry.id || index + 1)}</RecordID>
            <AccountID>${escapeXml(entry.account_code)}</AccountID>
            <SourceDocumentID>${escapeXml(entry.document_ref || '')}</SourceDocumentID>
            <Description>${escapeXml(entry.description || '')}</Description>
            ${debitAmount > 0 ? `<DebitAmount>
              <Amount>${formatAmount(debitAmount)}</Amount>
            </DebitAmount>` : ''}
            ${creditAmount > 0 ? `<CreditAmount>
              <Amount>${formatAmount(creditAmount)}</Amount>
            </CreditAmount>` : ''}
          </Line>
        </Transaction>`;
    }).join('');

    return `
      <Journal>
        <JournalID>${escapeXml(journalId)}</JournalID>
        <Description>${escapeXml(getJournalDescription(journalId))}</Description>
        <Type>GJ</Type>
        ${transactionsXml}
      </Journal>`;
  }).join('');

  return `
  <GeneralLedgerEntries>
    <NumberOfEntries>${numberOfEntries}</NumberOfEntries>
    <TotalDebit>${formatAmount(totalDebit)}</TotalDebit>
    <TotalCredit>${formatAmount(totalCredit)}</TotalCredit>
    ${journalsXml}
  </GeneralLedgerEntries>`;
};

/**
 * Retourne la description d'un journal
 */
const getJournalDescription = (journalId) => {
  const descriptions = {
    'VE': 'Journal des Ventes',
    'AC': 'Journal des Achats',
    'BQ': 'Journal de Banque',
    'CA': 'Journal de Caisse',
    'OD': 'Journal des Operations Diverses',
    'PA': 'Journal de Paie',
    'AN': 'Journal des A-nouveaux'
  };
  return descriptions[journalId] || 'Journal';
};

/**
 * Genere le nom de fichier SAF-T
 */
export const generateSAFTFilename = (companyInfo, period) => {
  const id = companyInfo.siren || companyInfo.tax_id || 'UNKNOWN';
  const endDate = formatDate(period.end).replace(/-/g, '');
  return `SAF-T_${id}_${endDate}.xml`;
};

/**
 * Exporte les donnees au format SAF-T
 * @param {Object} data - Donnees a exporter { accounts, customers, suppliers, entries }
 * @param {Object} companyInfo - Informations entreprise
 * @param {Object} period - Periode { start, end }
 * @returns {Object} { blob, filename, stats }
 */
export const exportSAFT = async (data, companyInfo, period) => {
  if (!companyInfo) {
    throw new Error('Informations entreprise requises');
  }

  const auditFileId = `${companyInfo.siren || 'CASHPILOT'}-${Date.now()}`;

  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<AuditFile xmlns="urn:OECD:StandardAuditFile-Tax:PT_1.04_01" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  ${generateHeader(companyInfo, period, auditFileId)}
  <MasterFiles>
    ${generateAccounts(data.accounts || [])}
    ${generateCustomers(data.customers || [])}
    ${generateSuppliers(data.suppliers || [])}
  </MasterFiles>
  ${generateEntries(data.entries || [])}
</AuditFile>`;

  const blob = new Blob([xml], { type: 'application/xml;charset=utf-8' });

  return {
    blob,
    filename: generateSAFTFilename(companyInfo, period),
    stats: {
      accounts: (data.accounts || []).length,
      customers: (data.customers || []).length,
      suppliers: (data.suppliers || []).length,
      entries: (data.entries || []).length
    }
  };
};

export default {
  exportSAFT,
  generateSAFTFilename
};
```

## Criteres de verification
- [ ] Fichier src/services/exportSAFT.js cree
- [ ] XML conforme au schema OCDE SAF-T
- [ ] Sections Header, MasterFiles, GeneralLedgerEntries presentes
- [ ] Escape XML correct pour tous les champs texte
- [ ] Build passe
- [ ] Lint passe

## Statut
- [ ] Complete
