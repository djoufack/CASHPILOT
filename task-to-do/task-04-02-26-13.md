# Task 13 - MOYENNE : Service invoiceExtractionService.js

## Fichiers a creer
- `src/services/invoiceExtractionService.js` (CREER)

## Probleme
Aucun service client n'existe pour appeler l'edge function extract-invoice.

## Solution
Creer un service suivant le pattern exact de `src/services/stripeService.js` :
- Import supabaseUrl et supabaseAnonKey
- Fonction `extractInvoiceData` qui appelle l'edge function
- Gestion d'erreur avec messages specifiques selon le status code

## Code attendu

```javascript
/**
 * Invoice Extraction Service
 * Calls the extract-invoice Edge Function to extract structured data
 * from supplier invoices using Google Gemini AI.
 */

import { supabaseUrl, supabaseAnonKey } from '@/lib/customSupabaseClient';

/**
 * Extract structured data from a supplier invoice file
 * @param {Object} params
 * @param {string} params.filePath - Storage path of the uploaded file
 * @param {string} params.fileType - MIME type (application/pdf, image/jpeg, image/png)
 * @param {string} params.userId - User ID
 * @returns {Promise<Object>} Extracted invoice data
 */
export const extractInvoiceData = async ({ filePath, fileType, userId }) => {
  if (!supabaseUrl) {
    throw new Error('Supabase URL not configured');
  }

  const response = await fetch(`${supabaseUrl}/functions/v1/extract-invoice`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${supabaseAnonKey}`,
    },
    body: JSON.stringify({ filePath, fileType, userId }),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ error: 'Extraction failed' }));

    if (response.status === 402) {
      throw new Error('insufficient_credits');
    }
    if (response.status === 404) {
      throw new Error('File not found in storage');
    }
    if (response.status === 422) {
      throw new Error('extraction_failed');
    }
    if (response.status === 502) {
      throw new Error('AI service temporarily unavailable');
    }

    throw new Error(error.error || error.message || 'Invoice extraction failed');
  }

  const result = await response.json();
  return result.data;
};
```

## Criteres de verification
- [ ] Fichier `src/services/invoiceExtractionService.js` existe
- [ ] Import supabaseUrl et supabaseAnonKey depuis customSupabaseClient
- [ ] Appel fetch vers `${supabaseUrl}/functions/v1/extract-invoice`
- [ ] Header Authorization avec Bearer + supabaseAnonKey
- [ ] Gestion erreurs 402, 404, 422, 502

## Statut
- [ ] Complete
