# Task 004 - [MOYENNE] : Service FEC Export France

## Fichier(s) a modifier
- `src/services/exportFEC.js` (nouveau fichier)

## Probleme
CashPilot ne permet pas d'exporter les ecritures comptables au format FEC (Fichier des Ecritures Comptables), format obligatoire pour l'administration fiscale francaise.

## Solution
Creer un service d'export FEC complet avec les 18 colonnes reglementaires et le format pipe-separated.

## Code attendu
```javascript
/**
 * Export FEC (Fichier des Ecritures Comptables)
 * Format obligatoire pour l'administration fiscale francaise
 * Norme Article A.47 A-1 du Livre des Procedures Fiscales
 */

const FEC_COLUMNS = [
  'JournalCode',    // Code journal
  'JournalLib',     // Libelle journal
  'EcritureNum',    // Numero ecriture
  'EcritureDate',   // Date ecriture (AAAAMMJJ)
  'CompteNum',      // Numero compte
  'CompteLib',      // Libelle compte
  'CompAuxNum',     // Numero compte auxiliaire
  'CompAuxLib',     // Libelle compte auxiliaire
  'PieceRef',       // Reference piece
  'PieceDate',      // Date piece (AAAAMMJJ)
  'EcritureLib',    // Libelle ecriture
  'Debit',          // Montant debit
  'Credit',         // Montant credit
  'EcritureLet',    // Lettrage
  'DateLet',        // Date lettrage
  'ValidDate',      // Date validation
  'Montantdevise',  // Montant devise
  'Idevise'         // Identifiant devise
];

const JOURNAL_CODES = {
  'sales': { code: 'VE', lib: 'Ventes' },
  'purchases': { code: 'AC', lib: 'Achats' },
  'bank': { code: 'BQ', lib: 'Banque' },
  'cash': { code: 'CA', lib: 'Caisse' },
  'misc': { code: 'OD', lib: 'Operations Diverses' },
  'payroll': { code: 'PA', lib: 'Paie' },
};

/**
 * Format une date au format FEC (AAAAMMJJ)
 */
const formatFECDate = (date) => {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '';
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}${month}${day}`;
};

/**
 * Format un montant au format FEC (virgule decimale)
 */
const formatFECAmount = (amount) => {
  if (amount === null || amount === undefined || amount === 0) return '';
  return Math.abs(amount).toFixed(2).replace('.', ',');
};

/**
 * Echappe les caracteres speciaux pour CSV
 */
const escapeField = (value) => {
  if (value === null || value === undefined) return '';
  const str = String(value);
  // Le FEC utilise | comme separateur, pas de guillemets
  return str.replace(/\|/g, ' ').replace(/[\r\n]/g, ' ').trim();
};

/**
 * Genere le nom de fichier FEC conforme
 * Format: SirenFECAAAAMMJJ.txt
 */
export const generateFECFilename = (siren, endDate) => {
  const dateStr = formatFECDate(endDate);
  return `${siren}FEC${dateStr}.txt`;
};

/**
 * Transforme les ecritures en format FEC
 */
const transformEntryToFEC = (entry, index) => {
  const journal = JOURNAL_CODES[entry.journal_type] || JOURNAL_CODES.misc;

  return {
    JournalCode: journal.code,
    JournalLib: journal.lib,
    EcritureNum: entry.entry_number || String(index + 1).padStart(6, '0'),
    EcritureDate: formatFECDate(entry.transaction_date),
    CompteNum: entry.account_code || '',
    CompteLib: escapeField(entry.account_name || ''),
    CompAuxNum: entry.auxiliary_account || '',
    CompAuxLib: escapeField(entry.auxiliary_name || ''),
    PieceRef: escapeField(entry.document_ref || ''),
    PieceDate: formatFECDate(entry.document_date || entry.transaction_date),
    EcritureLib: escapeField(entry.description || ''),
    Debit: entry.debit > 0 ? formatFECAmount(entry.debit) : '',
    Credit: entry.credit > 0 ? formatFECAmount(entry.credit) : '',
    EcritureLet: entry.lettrage || '',
    DateLet: entry.lettrage_date ? formatFECDate(entry.lettrage_date) : '',
    ValidDate: formatFECDate(entry.validated_at || entry.transaction_date),
    Montantdevise: entry.foreign_amount ? formatFECAmount(entry.foreign_amount) : '',
    Idevise: entry.foreign_currency || 'EUR'
  };
};

/**
 * Exporte les ecritures comptables au format FEC
 * @param {Array} entries - Ecritures comptables
 * @param {Object} companyInfo - Informations entreprise (siren, nom)
 * @param {Date} startDate - Date debut exercice
 * @param {Date} endDate - Date fin exercice
 * @returns {Blob} Fichier FEC (texte, encodage UTF-8 avec BOM)
 */
export const exportFEC = async (entries, companyInfo, startDate, endDate) => {
  // Validation des entrees
  if (!entries || entries.length === 0) {
    throw new Error('Aucune ecriture a exporter');
  }

  if (!companyInfo?.siren) {
    throw new Error('SIREN requis pour l\'export FEC');
  }

  // Trier les ecritures par date puis par numero
  const sortedEntries = [...entries].sort((a, b) => {
    const dateCompare = new Date(a.transaction_date) - new Date(b.transaction_date);
    if (dateCompare !== 0) return dateCompare;
    return (a.entry_number || 0) - (b.entry_number || 0);
  });

  // Transformer les ecritures
  const fecLines = sortedEntries.map((entry, index) => transformEntryToFEC(entry, index));

  // Generer le CSV avec separateur pipe
  const header = FEC_COLUMNS.join('|');
  const rows = fecLines.map(line =>
    FEC_COLUMNS.map(col => line[col] || '').join('|')
  );

  const csvContent = [header, ...rows].join('\r\n');

  // UTF-8 avec BOM pour compatibilite Excel/outils fiscaux
  const BOM = '\ufeff';
  const blob = new Blob([BOM + csvContent], {
    type: 'text/plain;charset=utf-8'
  });

  return {
    blob,
    filename: generateFECFilename(companyInfo.siren, endDate),
    rowCount: fecLines.length,
    period: { start: startDate, end: endDate }
  };
};

/**
 * Valide la structure d'une ecriture avant export
 */
export const validateEntry = (entry) => {
  const errors = [];

  if (!entry.transaction_date) {
    errors.push('Date transaction manquante');
  }
  if (!entry.account_code) {
    errors.push('Numero de compte manquant');
  }
  if (entry.debit === undefined && entry.credit === undefined) {
    errors.push('Montant debit ou credit requis');
  }
  if (entry.debit && entry.credit && entry.debit > 0 && entry.credit > 0) {
    errors.push('Une ecriture ne peut pas avoir debit ET credit');
  }

  return {
    isValid: errors.length === 0,
    errors
  };
};

/**
 * Verifie l'equilibre des ecritures
 */
export const checkBalance = (entries) => {
  const totalDebit = entries.reduce((sum, e) => sum + (e.debit || 0), 0);
  const totalCredit = entries.reduce((sum, e) => sum + (e.credit || 0), 0);
  const diff = Math.abs(totalDebit - totalCredit);

  return {
    balanced: diff < 0.01, // Tolerance 1 centime
    totalDebit,
    totalCredit,
    difference: diff
  };
};

export default {
  exportFEC,
  generateFECFilename,
  validateEntry,
  checkBalance,
  FEC_COLUMNS,
  JOURNAL_CODES
};
```

## Criteres de verification
- [ ] Fichier src/services/exportFEC.js cree
- [ ] 18 colonnes FEC definies conformement a la norme
- [ ] Format date AAAAMMJJ correct
- [ ] Format montant avec virgule decimale
- [ ] Separateur pipe (|)
- [ ] UTF-8 avec BOM
- [ ] Build passe
- [ ] Lint passe

## Statut
- [ ] Complete
