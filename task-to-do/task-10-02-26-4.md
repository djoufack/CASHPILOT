# Task 4 - [P0] : Créer tables accounting_plans + accounting_plan_accounts

## Fichier(s) à modifier
- Migration SQL Supabase (project_id: `rfzvrezrcigzmldgvntz`)

## Problème
Il n'existe pas de table pour stocker les modèles de plans comptables (templates). Les plans sont hardcodés dans des fichiers JSON. Pour l'onboarding, on a besoin d'une table de référence pour les plans système et les plans privés uploadés par les utilisateurs.

## Solution
```sql
-- Table des plans comptables (templates)
CREATE TABLE IF NOT EXISTS accounting_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  country_code TEXT,
  description TEXT,
  source TEXT DEFAULT 'system' CHECK (source IN ('system', 'user_upload', 'admin')),
  uploaded_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  is_global BOOLEAN DEFAULT false,
  file_url TEXT,
  accounts_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'pending_review', 'archived')),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Table des comptes d'un plan template
CREATE TABLE IF NOT EXISTS accounting_plan_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_id UUID NOT NULL REFERENCES accounting_plans(id) ON DELETE CASCADE,
  account_code TEXT NOT NULL,
  account_name TEXT NOT NULL,
  account_type TEXT NOT NULL CHECK (account_type IN ('asset', 'liability', 'equity', 'revenue', 'expense')),
  account_category TEXT,
  parent_code TEXT,
  UNIQUE(plan_id, account_code)
);

-- Index
CREATE INDEX idx_accounting_plans_global ON accounting_plans(is_global) WHERE is_global = true;
CREATE INDEX idx_accounting_plans_uploaded_by ON accounting_plans(uploaded_by);
CREATE INDEX idx_accounting_plan_accounts_plan_id ON accounting_plan_accounts(plan_id);

-- RLS
ALTER TABLE accounting_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE accounting_plan_accounts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view global plans" ON accounting_plans
  FOR SELECT USING (is_global = true OR uploaded_by = auth.uid());

CREATE POLICY "Users can create private plans" ON accounting_plans
  FOR INSERT WITH CHECK (uploaded_by = auth.uid() AND is_global = false);

CREATE POLICY "Users can view plan accounts for accessible plans" ON accounting_plan_accounts
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM accounting_plans
      WHERE accounting_plans.id = accounting_plan_accounts.plan_id
      AND (accounting_plans.is_global = true OR accounting_plans.uploaded_by = auth.uid())
    )
  );
```

## Statut
- [ ] Complète
