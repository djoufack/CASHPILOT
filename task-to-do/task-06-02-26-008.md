# Task 008 - [MOYENNE] : Service VAT Declaration

## Fichier(s) a creer
- `src/services/vatDeclarationService.js`

## Probleme
CashPilot ne permet pas de generer automatiquement les declarations de TVA (CA3 France, Intervat Belgique).

## Solution
Creer un service de generation de declarations TVA avec support multi-pays.

## Code attendu
```javascript
/**
 * VAT Declaration Service
 * Generates VAT declarations for France (CA3) and Belgium (Intervat)
 */

import { supabase } from '@/lib/supabase';

/**
 * Calculate VAT breakdown for a period
 * @param {string} userId - User ID
 * @param {Date} startDate - Period start
 * @param {Date} endDate - Period end
 * @returns {Object} VAT breakdown
 */
export const calculateVATBreakdown = async (userId, startDate, endDate) => {
  // Fetch invoices for the period
  const { data: invoices, error: invoicesError } = await supabase
    .from('invoices')
    .select('total_ht, total_vat, total_ttc, vat_rate, status, invoice_date')
    .eq('user_id', userId)
    .gte('invoice_date', startDate.toISOString())
    .lte('invoice_date', endDate.toISOString())
    .in('status', ['paid', 'sent', 'validated']);

  if (invoicesError) throw invoicesError;

  // Fetch expenses for the period
  const { data: expenses, error: expensesError } = await supabase
    .from('expenses')
    .select('amount, vat_amount, vat_rate, date, category')
    .eq('user_id', userId)
    .gte('date', startDate.toISOString())
    .lte('date', endDate.toISOString());

  if (expensesError) throw expensesError;

  // Calculate output VAT (TVA collectee)
  const outputVAT = {
    total: 0,
    byRate: {}
  };

  (invoices || []).forEach(inv => {
    const rate = inv.vat_rate || 20;
    outputVAT.total += inv.total_vat || 0;
    if (!outputVAT.byRate[rate]) {
      outputVAT.byRate[rate] = { base: 0, vat: 0 };
    }
    outputVAT.byRate[rate].base += inv.total_ht || 0;
    outputVAT.byRate[rate].vat += inv.total_vat || 0;
  });

  // Calculate input VAT (TVA deductible)
  const inputVAT = {
    total: 0,
    goods: 0,
    services: 0,
    byCategory: {}
  };

  const goodsCategories = ['stock', 'equipment', 'supplies', 'inventory'];
  const servicesCategories = ['services', 'subscriptions', 'professional_fees', 'utilities'];

  (expenses || []).forEach(exp => {
    const vatAmount = exp.vat_amount || 0;
    inputVAT.total += vatAmount;

    if (goodsCategories.includes(exp.category?.toLowerCase())) {
      inputVAT.goods += vatAmount;
    } else {
      inputVAT.services += vatAmount;
    }

    const cat = exp.category || 'other';
    if (!inputVAT.byCategory[cat]) {
      inputVAT.byCategory[cat] = 0;
    }
    inputVAT.byCategory[cat] += vatAmount;
  });

  // Calculate net VAT
  const netVAT = outputVAT.total - inputVAT.total;

  return {
    period: { start: startDate, end: endDate },
    totalRevenue: (invoices || []).reduce((sum, inv) => sum + (inv.total_ht || 0), 0),
    totalExpenses: (expenses || []).reduce((sum, exp) => sum + (exp.amount || 0), 0),
    outputVAT,
    inputVAT,
    netVAT,
    vatDue: netVAT > 0 ? netVAT : 0,
    vatCredit: netVAT < 0 ? Math.abs(netVAT) : 0,
    invoiceCount: (invoices || []).length,
    expenseCount: (expenses || []).length
  };
};

/**
 * Generate French CA3 VAT Declaration
 * @param {Object} vatData - VAT breakdown from calculateVATBreakdown
 * @param {Object} companyInfo - Company information
 * @returns {Object} CA3 declaration data
 */
export const generateCA3 = (vatData, companyInfo) => {
  const { outputVAT, inputVAT, period } = vatData;

  // CA3 form structure
  return {
    formType: 'CA3',
    period: {
      month: period.start.getMonth() + 1,
      year: period.start.getFullYear(),
      start: period.start,
      end: period.end
    },
    company: {
      name: companyInfo.company_name,
      siret: companyInfo.siret,
      vatNumber: companyInfo.vat_number,
      address: companyInfo.address
    },
    // Section A - Operations imposables
    sectionA: {
      line01_ventes_france: outputVAT.byRate[20]?.base || 0,
      line02_autres_operations: 0,
      line03_acquisitions_intra: 0,
      line04_importations: 0,
      line05_livraisons_gaz: 0,
      line06_achats_autoliquidation: 0
    },
    // Section B - TVA brute
    sectionB: {
      line08_tva_collectee_20: outputVAT.byRate[20]?.vat || 0,
      line09_tva_collectee_10: outputVAT.byRate[10]?.vat || 0,
      line9B_tva_collectee_5_5: outputVAT.byRate[5.5]?.vat || 0,
      line10_tva_collectee_2_1: outputVAT.byRate[2.1]?.vat || 0,
      line11_tva_acquisitions_intra: 0,
      line12_tva_importations: 0,
      line13_tva_monaco: 0,
      line14_tva_petroliers: 0,
      line15_total_tva_brute: outputVAT.total
    },
    // Section C - TVA deductible
    sectionC: {
      line19_tva_biens: inputVAT.goods,
      line20_tva_services: inputVAT.services,
      line21_autre_tva_deductible: 0,
      line22_report_credit: 0,
      line23_total_deductible: inputVAT.total
    },
    // Section D - TVA nette
    sectionD: {
      line24_tva_nette: vatData.netVAT > 0 ? vatData.netVAT : 0,
      line25_credit_tva: vatData.netVAT < 0 ? Math.abs(vatData.netVAT) : 0,
      line26_remboursement_demande: 0,
      line27_credit_reporter: vatData.netVAT < 0 ? Math.abs(vatData.netVAT) : 0,
      line28_tva_a_payer: vatData.vatDue
    },
    // Summary
    summary: {
      totalOutputVAT: outputVAT.total,
      totalInputVAT: inputVAT.total,
      netVAT: vatData.netVAT,
      amountDue: vatData.vatDue,
      creditAmount: vatData.vatCredit
    },
    generatedAt: new Date().toISOString()
  };
};

/**
 * Generate Belgian Intervat Declaration
 * @param {Object} vatData - VAT breakdown
 * @param {Object} companyInfo - Company information
 * @returns {Object} Intervat declaration data
 */
export const generateIntervat = (vatData, companyInfo) => {
  const { outputVAT, inputVAT, period } = vatData;

  return {
    formType: 'INTERVAT',
    period: {
      quarter: Math.ceil((period.start.getMonth() + 1) / 3),
      year: period.start.getFullYear(),
      start: period.start,
      end: period.end
    },
    company: {
      name: companyInfo.company_name,
      enterpriseNumber: companyInfo.enterprise_number,
      vatNumber: companyInfo.vat_number,
      address: companyInfo.address
    },
    // Grid structure for Intervat
    grids: {
      // Operations a la sortie (Output)
      grid00: outputVAT.byRate[21]?.base || 0, // CA 21%
      grid01: outputVAT.byRate[12]?.base || 0, // CA 12%
      grid02: outputVAT.byRate[6]?.base || 0,  // CA 6%
      grid03: 0, // Services intra-UE

      // TVA due
      grid54: outputVAT.byRate[21]?.vat || 0,  // TVA 21%
      grid55: outputVAT.byRate[12]?.vat || 0,  // TVA 12%
      grid56: outputVAT.byRate[6]?.vat || 0,   // TVA 6%

      // Operations a l'entree (Input)
      grid81: inputVAT.goods,     // Achats marchandises
      grid82: inputVAT.services,  // Services
      grid83: 0,                  // Investissements

      // TVA deductible
      grid59: inputVAT.total,

      // Solde
      grid71: vatData.vatDue,     // TVA a payer
      grid72: vatData.vatCredit   // Credit TVA
    },
    summary: {
      totalOutputVAT: outputVAT.total,
      totalInputVAT: inputVAT.total,
      netVAT: vatData.netVAT,
      amountDue: vatData.vatDue,
      creditAmount: vatData.vatCredit
    },
    generatedAt: new Date().toISOString()
  };
};

/**
 * Generate VAT declaration based on country
 * @param {string} userId - User ID
 * @param {Object} period - { start, end }
 * @param {string} country - Country code (FR, BE)
 * @param {Object} companyInfo - Company information
 * @returns {Object} Declaration data
 */
export const generateVATDeclaration = async (userId, period, country, companyInfo) => {
  const vatData = await calculateVATBreakdown(userId, period.start, period.end);

  switch (country.toUpperCase()) {
    case 'FR':
      return generateCA3(vatData, companyInfo);
    case 'BE':
      return generateIntervat(vatData, companyInfo);
    default:
      throw new Error(`Unsupported country: ${country}`);
  }
};

/**
 * Export declaration as JSON
 */
export const exportDeclarationJSON = (declaration) => {
  const json = JSON.stringify(declaration, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  return {
    blob,
    filename: `vat-declaration-${declaration.formType}-${declaration.period.year}-${declaration.period.month || declaration.period.quarter}.json`
  };
};

export default {
  calculateVATBreakdown,
  generateCA3,
  generateIntervat,
  generateVATDeclaration,
  exportDeclarationJSON
};
```

## Criteres de verification
- [ ] Fichier src/services/vatDeclarationService.js cree
- [ ] Calcul TVA collectee depuis invoices
- [ ] Calcul TVA deductible depuis expenses
- [ ] Format CA3 France correct
- [ ] Format Intervat Belgique correct
- [ ] Build passe

## Statut
- [ ] Complete
