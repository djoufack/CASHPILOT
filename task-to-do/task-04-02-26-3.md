# Task 3 - CRITIQUE : Corriger race condition dans useSubtasks.js

## Fichier a modifier
- `src/hooks/useSubtasks.js`

## Probleme
Le useEffect (lignes 113-139) a `fetchSubtasks` dans ses dependances. Comme `fetchSubtasks` est recree a chaque changement de `taskId` (useCallback), le useEffect se re-execute, creant potentiellement des subscriptions empilees. De plus, `fetchSubtasks()` est appele AVANT le guard `if (!taskId || !supabase) return;`, ce qui signifie que la subscription et le fetch ne sont pas correctement coordonnes.

## Solution
Retirer `fetchSubtasks` du tableau de dependances et ne garder que `taskId`. Appeler fetchSubtasks dans le useEffect directement.

## Code attendu (useEffect seulement)
```js
useEffect(() => {
  if (!taskId || !supabase) return;

  fetchSubtasks();

  const subscription = supabase
    .channel(`subtasks:task_id=eq.${taskId}`)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'subtasks',
      filter: `task_id=eq.${taskId}`
    }, (payload) => {
      if (payload.eventType === 'INSERT') {
        setSubtasks(prev => [...prev, payload.new]);
      } else if (payload.eventType === 'UPDATE') {
        setSubtasks(prev => prev.map(st => st.id === payload.new.id ? payload.new : st));
      } else if (payload.eventType === 'DELETE') {
        setSubtasks(prev => prev.filter(st => st.id !== payload.old.id));
      }
    })
    .subscribe();

  return () => {
    supabase.removeChannel(subscription);
  };
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [taskId]);
```

## Statut
- [ ] Complete
