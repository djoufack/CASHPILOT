# Task 19 - HAUTE : Refonte UploadInvoiceModal avec extraction IA

## Fichiers a modifier
- `src/components/UploadInvoiceModal.jsx` (refonte majeure)

## Probleme
Le modal actuel ne supporte que les PDF, n'a aucune integration IA, et requiert une saisie manuelle de toutes les donnees.

## Solution
Refondre le composant pour :
1. Accepter PDF + images (JPG, PNG)
2. Ajouter un bouton "Extraire avec l'IA" apres selection du fichier
3. Afficher un loader pendant l'extraction
4. Pre-remplir le formulaire avec les donnees extraites
5. Afficher un indicateur de confiance
6. Ajouter une section "Details avances" (Accordion) avec total_ht, total_tva, currency, etc.
7. Afficher les lignes de facture extraites
8. Integrer le credits guard

## Imports supplementaires necessaires
- `useInvoiceExtraction` depuis `@/hooks/useInvoiceExtraction`
- `useCreditsGuard, CREDIT_COSTS` depuis `@/hooks/useCreditsGuard`
- `useAuth` depuis `@/context/AuthContext`
- `useTranslation` depuis `react-i18next`
- `Sparkles, Loader2, ChevronDown, ChevronUp` depuis `lucide-react`
- `Badge` depuis `@/components/ui/badge`
- `Accordion, AccordionContent, AccordionItem, AccordionTrigger` depuis `@/components/ui/accordion`
- `supabase` depuis `@/lib/supabase`

## Changements structurels

### Etats supplementaires
```javascript
const [showAdvanced, setShowAdvanced] = useState(false);
const [advancedData, setAdvancedData] = useState({
  total_ht: '', total_tva: '', currency: 'EUR',
  supplier_vat_number: '', payment_terms: '', iban: '', bic: ''
});
const [lineItems, setLineItems] = useState([]);
const [uploadedFilePath, setUploadedFilePath] = useState(null);
```

### Hooks supplementaires
```javascript
const { extractInvoice, extracting, extractedData, clearExtraction } = useInvoiceExtraction();
const { guardedAction, modalProps } = useCreditsGuard();
const { user } = useAuth();
const { t } = useTranslation();
```

### Accepter images
- `handleFileChange` : types valides = `['application/pdf', 'image/jpeg', 'image/png']`
- `handleDrop` : meme validation
- `<input accept="application/pdf,image/jpeg,image/png">`

### Fonction handleExtract
```javascript
const handleExtract = async () => {
  if (!file || !user) return;
  // Upload file first to get storage path
  const fileExt = file.name.split('.').pop();
  const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
  const filePath = `temp-extraction/${user.id}/${fileName}`;

  const { error: uploadError } = await supabase.storage
    .from('supplier-invoices')
    .upload(filePath, file, { contentType: file.type });

  if (uploadError) { /* toast error */ return; }
  setUploadedFilePath(filePath);

  await guardedAction(CREDIT_COSTS.AI_INVOICE_EXTRACTION, t('invoiceExtraction.extractWithAI'), async () => {
    const data = await extractInvoice(filePath, file.type, user.id);
    if (data) {
      setFormData({
        invoice_number: data.invoice_number || '',
        invoice_date: data.invoice_date || new Date().toISOString().split('T')[0],
        due_date: data.due_date || '',
        total_amount: data.total_ttc?.toString() || '',
        vat_rate: data.tva_rate?.toString() || '20',
        payment_status: 'pending',
      });
      setAdvancedData({
        total_ht: data.total_ht?.toString() || '',
        total_tva: data.total_tva?.toString() || '',
        currency: data.currency || 'EUR',
        supplier_vat_number: data.supplier_vat_number || '',
        payment_terms: data.payment_terms || '',
        iban: data.iban || '',
        bic: data.bic || '',
      });
      if (data.line_items?.length) setLineItems(data.line_items);
    }
  });
};
```

### Bouton "Extraire avec l'IA" (apres la zone de fichier, avant les champs)
```jsx
{file && !extractedData && (
  <Button type="button" onClick={handleExtract} disabled={extracting}
    className="w-full bg-purple-600 hover:bg-purple-700">
    {extracting ? (
      <><Loader2 className="h-4 w-4 mr-2 animate-spin" />{t('invoiceExtraction.extracting')}</>
    ) : (
      <><Sparkles className="h-4 w-4 mr-2" />{t('invoiceExtraction.extractWithAI')}
        <span className="ml-2 text-xs opacity-70">({CREDIT_COSTS.AI_INVOICE_EXTRACTION} {t('invoiceExtraction.creditsCost')})</span>
      </>
    )}
  </Button>
)}
```

### Indicateur de confiance (apres le bouton extract)
```jsx
{extractedData && (
  <div className="flex items-center gap-2 text-sm">
    <Badge className={confidence > 0.8 ? 'bg-green-600' : confidence > 0.5 ? 'bg-yellow-600' : 'bg-red-600'}>
      {t(`invoiceExtraction.confidence${confidence > 0.8 ? 'High' : confidence > 0.5 ? 'Medium' : 'Low'}`)}
    </Badge>
    <span className="text-gray-400">{t('invoiceExtraction.reviewData')}</span>
  </div>
)}
```

### Section Details avances (Accordion apres le formulaire principal)
Champs : total_ht, total_tva, currency, supplier_vat_number, payment_terms, iban, bic

### Tableau des lignes (si lineItems.length > 0)
Table avec colonnes : Description, Qty, Unit Price, Total

### handleSubmit modifie
Inclure advancedData et ai_* dans les donnees passees a onUploadSuccess :
```javascript
const submitData = {
  ...formData,
  ...advancedData,
  ai_extracted: !!extractedData,
  ai_confidence: extractedData?.confidence || null,
  ai_raw_response: extractedData || null,
  ai_extracted_at: extractedData ? new Date().toISOString() : null,
};
```

## Criteres de verification
- [ ] Accepte PDF, JPG, PNG
- [ ] Bouton "Extraire avec l'IA" visible apres selection du fichier
- [ ] Loader anime pendant l'extraction
- [ ] Pre-remplissage du formulaire apres extraction
- [ ] Badge de confiance colore
- [ ] Section "Details avances" avec champs supplementaires
- [ ] Tableau des lignes de facture
- [ ] Credits guard integre
- [ ] Donnees AI incluses dans le submit

## Statut
- [ ] Complete
