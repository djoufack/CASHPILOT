# Update 05-02-26 18:10 - AI Chatbot & Credits System Fixes

## Resume

Corrections critiques du chatbot IA et du systeme de credits pour assurer le bon fonctionnement de l'assistant comptable.

---

## Problemes resolus

### 1. Erreur "insufficient_credits" malgre 50 credits disponibles

**Cause**: L'Edge Function `ai-chatbot` selectionnait une colonne `balance` inexistante au lieu des colonnes correctes `free_credits` et `paid_credits`.

**Fichier**: `supabase/functions/ai-chatbot/index.ts`

**Correction**:
```typescript
// AVANT (incorrect)
const { data: credits } = await supabase
  .from('user_credits')
  .select('balance')
  .eq('user_id', userId)
  .single();

// APRES (correct)
const { data: credits } = await supabase
  .from('user_credits')
  .select('free_credits, paid_credits')
  .eq('user_id', userId)
  .single();

const availableCredits = (credits?.free_credits || 0) + (credits?.paid_credits || 0);
```

---

### 2. Credits non debites apres envoi de message

**Cause**: Le champ `updated_at` manquait dans la requete de mise a jour, ce qui pouvait causer des problemes de synchronisation.

**Fichier**: `supabase/functions/ai-chatbot/index.ts`

**Correction**:
```typescript
// Deduction intelligente: free_credits d'abord, puis paid_credits
const freeDeduction = Math.min(credits.free_credits, CREDIT_COST);
const paidDeduction = CREDIT_COST - freeDeduction;

const { error: updateError } = await supabase
  .from('user_credits')
  .update({
    free_credits: credits.free_credits - freeDeduction,
    paid_credits: credits.paid_credits - paidDeduction,
    updated_at: new Date().toISOString()  // AJOUTE
  })
  .eq('user_id', userId);

if (updateError) {
  console.error('Credit update error:', updateError);
}
```

---

### 3. Affichage des credits non rafraichi apres message

**Cause**: Le hook `useCredits` ne recuperait les credits qu'au montage du composant, pas apres chaque message envoye.

**Fichier**: `src/components/AIChatWidget.jsx`

**Correction**:
```javascript
import { useCredits } from '@/hooks/useCredits';

const AIChatWidget = () => {
  const { fetchCredits } = useCredits();

  const handleSend = async () => {
    if (!input.trim() || isLoading) return;
    const text = input;
    setInput('');
    await sendMessage(text);
    fetchCredits();  // AJOUTE - Rafraichir les credits apres envoi
  };
  // ...
};
```

---

### 4. Messages d'erreur non affiches dans le chatbot

**Cause**: Le hook `useAIChat` ne gerait pas tous les types d'erreurs de maniere explicite.

**Fichier**: `src/hooks/useAIChat.js`

**Correction**:
```javascript
if (data.error === 'insufficient_credits') {
  setMessages(prev => [...prev, {
    role: 'assistant',
    content: 'Credits insuffisants pour utiliser le chatbot IA. Rechargez vos credits pour continuer.',
    timestamp: new Date().toISOString(),
    isError: true,
  }]);
} else if (data.error) {
  setMessages(prev => [...prev, {
    role: 'assistant',
    content: `Erreur: ${data.error}`,
    timestamp: new Date().toISOString(),
    isError: true,
  }]);
} else if (data.reply) {
  setMessages(prev => [...prev, {
    role: 'assistant',
    content: data.reply,
    timestamp: new Date().toISOString(),
  }]);
} else {
  setMessages(prev => [...prev, {
    role: 'assistant',
    content: 'Reponse inattendue du serveur.',
    timestamp: new Date().toISOString(),
    isError: true,
  }]);
}
```

---

## Schema de la table user_credits

```sql
CREATE TABLE user_credits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  free_credits INTEGER DEFAULT 10,
  paid_credits INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## Fichiers modifies

| Fichier | Modification |
|---------|--------------|
| `supabase/functions/ai-chatbot/index.ts` | Selection correcte des colonnes, deduction intelligente, champ updated_at |
| `src/hooks/useAIChat.js` | Gestion complete des erreurs avec messages explicites |
| `src/components/AIChatWidget.jsx` | Auto-refresh des credits apres chaque message |

---

## Cout en credits

- **CREDIT_COST = 2** par message envoye au chatbot IA
- Deduction prioritaire sur `free_credits`, puis sur `paid_credits`
- Remboursement automatique en cas d'erreur API Gemini

---

## Tests de validation

1. Envoyer un message avec 50 credits -> Message traite, 2 credits debites
2. Verifier l'affichage des credits -> Mis a jour automatiquement sans refresh
3. Envoyer un message avec 0 credits -> Message d'erreur "Credits insuffisants"
4. Simuler erreur API -> Credits rembourses automatiquement

---

## Date

5 fevrier 2026, 18:10